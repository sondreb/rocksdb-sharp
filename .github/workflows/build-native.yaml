name: Build (Native)

on:
  push:
    branches:
      - master
      - feature/*

  workflow_dispatch:

jobs:

  buildAndUnitTest:

    strategy:
      matrix:
        os: [ windows-latest, ubuntu-latest, macos-latest ]

        include:
          - os: windows-latest
            extension: ".dll"
            runtime: "win-x64"
            filename: "rocksdb.dll"
          - os: ubuntu-latest
            extension: ".so"
            runtime: "linux-x64"
            filename: "librocksdb.so"
          - os: macos-latest
            runtime: "osx-x64"
            extension: ".dylib"
            filename: "librocksdb.dylib"

        #os: [ ubuntu-latest ]
      fail-fast: false

    runs-on: ${{ matrix.os }}

    env:
      SOLUTION_PATH: 'src/RocksDB.sln'
      BUILD_CONFIGURATION: 'Release'

    steps:

    - uses: actions/checkout@v2
      name: Checkout

    - name: Variables
      run: |
        ROCKSDBVNUM=`cat rocksdbversion`
        echo "ROCKSDBVERSION=$(cat rocksdbversion)" >> $GITHUB_ENV
      shell: bash

    - name: List variable
      run: |
        echo $ROCKSDBVERSION
      shell: bash

    # - name: Display folders
    #   working-directory: ${{ github.workspace }}
    #   run: ls -la

    - name: Display structure of files
      run: ls -R

    - name: Build Linux/Mac
      if: matrix.os != 'windows-latest'
      run: |
        chmod +x ./build-rocksdb.sh
        sh ./build-rocksdb.sh
      shell: bash
      working-directory: ${{ github.workspace }}/build-native/

    - name: Build Windows
      if: matrix.os == 'windows-latest'
      run: |
        call "C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Enterprise\\Common7\\Tools\\vsdevcmd" -arch=x64 && bash build-rocksdb.sh
      shell: cmd
      working-directory: ${{ github.workspace }}/build-native/

    - name: Display structure of files
      run: ls -R

    - uses: actions/upload-artifact@v2
      with:
        name: Blockcore-RocksDB-${{env.ROCKSDBVERSION}}-${{matrix.os}}-preview
        path: "${{github.workspace}}/build-native/runtimes/"

    - name: Release
      uses: sondreb/action-release@master
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        files: "${{github.workspace}}/build-native/runtimes/${{ matrix.runtime }}/native/${{ matrix.filename }}"
        draft: true
        prerelease: false
        body: ''
        name: "Blockcore RocksDB Native (Release ${{env.ROCKSDBVERSION}})"
        tag: ${{env.ROCKSDBVERSION}}

    # - name: Display structure of files
    #   run: ls -hR

    # - name: Build 6
    #   run: |
    #     chmod +x ${GITHUB_WORKSPACE}/build-native/build-rocksdb.sh
    #     sh ${GITHUB_WORKSPACE}/build-native/build-rocksdb.sh
    #   shell: bash
    #   continue-on-error: true

    # - name: Build
    #   run: |
    #     #chmod +x "build-rocksdb.sh"
    #     "./build-native/build-rocksdb.sh"
    #   shell: bash
    #   working-directory: "${GITHUB_WORKSPACE}"
